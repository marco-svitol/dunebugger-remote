version: '3.8'

services:
  dunebugger-remote:
    image: dunebugger-remote:arm64
    platform: linux/arm64  
    container_name: dunebugger-remote
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - PYTHONPATH=/app
      - LOG_LEVEL=${LOG_LEVEL:-DEBUG}
      - ENVIRONMENT=${ENVIRONMENT:-production}
    secrets:
      - db_password
      - auth0_client_secret
      - api_key
    volumes:
      - /etc/dunebugger-remote/config:/app/app/config:ro
    networks:
      - dunebugger-network
    depends_on:
      - nats-server

  nats-server:
    image: nats:latest
    platform: linux/arm64
    container_name: nats-server
    restart: unless-stopped
    ports:
      - "4222:4222"
      - "8222:8222"
    networks:
      - dunebugger-network
    command: ["-m", "8222", "-DV"]

networks:
  dunebugger-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16

secrets:
  db_password:
    file: ./secrets/db_password.txt
  auth0_client_secret:
    file: ./secrets/auth0_client_secret.txt
  api_key:
    file: ./secrets/api_key.txt